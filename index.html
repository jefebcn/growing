<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GrowManager üåø</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080b0d;
  --bg2: #0e1317;
  --bg3: #141b20;
  --card: #111619;
  --border: #1c2830;
  --border2: #243040;
  --green: #3dff7a;
  --green-dim: rgba(61,255,122,0.12);
  --green-glow: rgba(61,255,122,0.25);
  --purple: #b060ff;
  --purple-dim: rgba(176,96,255,0.12);
  --amber: #ffb830;
  --amber-dim: rgba(255,184,48,0.12);
  --red: #ff4d6d;
  --blue: #38c8ff;
  --text: #ddeae2;
  --muted: #4a6655;
  --muted2: #2a3d32;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg)}
body{font-family:'Outfit',sans-serif;color:var(--text);overscroll-behavior:none}

/* NOISE OVERLAY */
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  opacity:.5}

/* SCANLINES */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9998;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px)}

.app{max-width:430px;margin:0 auto;height:100vh;display:flex;flex-direction:column;position:relative;overflow:hidden}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;gap:16px}
.load-logo{font-size:48px;animation:breathe 2s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1);filter:drop-shadow(0 0 10px rgba(61,255,122,0.3))}50%{transform:scale(1.1);filter:drop-shadow(0 0 25px rgba(61,255,122,0.7))}}
.load-text{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:4px;color:var(--muted);text-transform:uppercase;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-screen{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:500;padding:32px;gap:24px}
.login-logo{text-align:center}
.login-logo span{font-size:52px;display:block;margin-bottom:12px;filter:drop-shadow(0 0 20px rgba(61,255,122,0.5))}
.login-logo h1{font-size:34px;font-weight:800;letter-spacing:-1px}
.login-logo p{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--muted);margin-top:4px}
.login-cards{display:grid;gap:14px;width:100%}
.login-card{padding:22px;border-radius:18px;cursor:pointer;text-align:center;border:1px solid;transition:all .2s;font-weight:800;font-size:20px}
.login-card:active{transform:scale(0.97)}
.login-card.live{background:var(--green-dim);border-color:rgba(61,255,122,0.3);color:var(--green)}
.login-card.live:hover{box-shadow:0 0 30px var(--green-glow);border-color:rgba(61,255,122,0.6)}
.login-card.lil{background:var(--purple-dim);border-color:rgba(176,96,255,0.3);color:var(--purple)}
.login-card.lil:hover{box-shadow:0 0 30px rgba(176,96,255,0.25);border-color:rgba(176,96,255,0.6)}
.login-sub{font-size:12px;font-family:'DM Mono',monospace;color:var(--muted);margin-top:6px}

/* ‚îÄ‚îÄ CONTENT AREA ‚îÄ‚îÄ */
.content{flex:1;overflow-y:auto;padding:18px 16px 95px;position:relative;z-index:1}
.content::-webkit-scrollbar{width:0}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(11,16,19,.95);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--border);display:flex;padding:10px 0 22px;z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;color:var(--muted);font-size:8px;font-family:'DM Mono',monospace;letter-spacing:.5px;text-transform:uppercase;background:none;border:none;outline:none;position:relative;transition:color .2s;padding:4px 0}
.nav-btn.active{color:var(--green)}
.nav-btn.active svg{filter:drop-shadow(0 0 6px var(--green))}
.nav-btn svg{width:22px;height:22px;transition:transform .15s}
.nav-btn:active svg{transform:scale(.9)}
.notif-dot{position:absolute;top:2px;right:calc(50% - 16px);width:7px;height:7px;background:var(--green);border-radius:50%;border:2px solid var(--bg2);animation:ping 2s infinite}
@keyframes ping{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.4)}}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;animation:fadeIn .2s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
.page-eyebrow{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
.page-title{font-size:26px;font-weight:800;letter-spacing:-.5px;margin-bottom:18px;line-height:1.1}
.section-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:10px}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;transition:border-color .2s}
.card-green{border-color:rgba(61,255,122,0.2);box-shadow:0 0 30px rgba(61,255,122,0.05)}
.card-purple{border-color:rgba(176,96,255,0.2);box-shadow:0 0 30px rgba(176,96,255,0.05)}
.card-amber{border-color:rgba(255,184,48,0.2);box-shadow:0 0 30px rgba(255,184,48,0.05)}

/* ‚îÄ‚îÄ PROFIT SPLIT ‚îÄ‚îÄ */
.split-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.split-side{border-radius:14px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.split-side::before{content:'';position:absolute;inset:0;opacity:.06;pointer-events:none}
.split-side.live{background:linear-gradient(145deg,rgba(61,255,122,.13),rgba(61,255,122,.04));border:1px solid rgba(61,255,122,.3)}
.split-side.live::before{background:radial-gradient(circle at 70% 20%, var(--green), transparent 60%)}
.split-side.lil{background:linear-gradient(145deg,rgba(176,96,255,.13),rgba(176,96,255,.04));border:1px solid rgba(176,96,255,.3)}
.split-side.lil::before{background:radial-gradient(circle at 30% 20%, var(--purple), transparent 60%)}
.split-side:active{transform:scale(.97)}
.split-name{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;margin-bottom:5px;opacity:.6}
.split-amount{font-size:28px;font-weight:800;line-height:1;letter-spacing:-1px}
.split-amount.live{color:var(--green);text-shadow:0 0 20px rgba(61,255,122,.4)}
.split-amount.lil{color:var(--purple);text-shadow:0 0 20px rgba(176,96,255,.4)}
.split-pct{font-family:'DM Mono',monospace;font-size:10px;margin-top:4px;opacity:.5}
.split-footer{text-align:center;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);padding-top:10px;border-top:1px solid var(--border);margin-top:10px}
.split-footer span{color:var(--green)}

/* ‚îÄ‚îÄ STAT TILES ‚îÄ‚îÄ */
.tiles{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.tile{background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:13px;text-align:center}
.tile-val{font-size:22px;font-weight:800;line-height:1}
.tile-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--muted);margin-top:4px}
.tile-val.g{color:var(--green);text-shadow:0 0 12px rgba(61,255,122,.3)}
.tile-val.a{color:var(--amber);text-shadow:0 0 12px rgba(255,184,48,.3)}
.tile-val.r{color:var(--red)}
.tile-val.p{color:var(--purple);text-shadow:0 0 12px rgba(176,96,255,.3)}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;padding:3px 9px;border-radius:20px;font-weight:700;text-transform:uppercase}
.badge-g{background:var(--green-dim);color:var(--green);border:1px solid rgba(61,255,122,.3)}
.badge-p{background:var(--purple-dim);color:var(--purple);border:1px solid rgba(176,96,255,.3)}
.badge-a{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(255,184,48,.3)}
.badge-r{background:rgba(255,77,109,.1);color:var(--red);border:1px solid rgba(255,77,109,.3)}
.badge-m{background:rgba(74,102,85,.1);color:var(--muted);border:1px solid var(--border)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;border:none;border-radius:12px;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:14px;padding:11px 18px;transition:all .2s;outline:none}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--green);color:#060c09}
.btn-primary:hover{background:#50ff8a;box-shadow:0 0 25px var(--green-glow)}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--green);color:var(--green)}
.btn-danger{background:rgba(255,77,109,.1);color:var(--red);border:1px solid rgba(255,77,109,.3)}
.btn-sm{padding:7px 12px;font-size:12px;border-radius:9px}
.btn-icon{width:36px;height:36px;padding:0;border-radius:10px;flex-shrink:0}
.btn-full{width:100%}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.field{margin-bottom:13px}
.field label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:7px}
input,textarea,select{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:11px 13px;font-family:'Outfit',sans-serif;font-size:14px;width:100%;outline:none;transition:border-color .2s;-webkit-appearance:none}
input:focus,textarea:focus,select:focus{border-color:var(--green)}
input::placeholder,textarea::placeholder{color:var(--muted2)}
select option{background:var(--bg3)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
textarea{resize:none}

/* ‚îÄ‚îÄ PLANT CARD ‚îÄ‚îÄ */
.plant-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.plant-card::after{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;transition:background .2s}
.plant-card.growing::after{background:var(--green)}
.plant-card.drying::after{background:var(--amber)}
.plant-card.done::after{background:var(--purple)}
.plant-card:active{transform:scale(.99);border-color:rgba(61,255,122,.25)}
.plant-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.plant-name{font-weight:700;font-size:17px;letter-spacing:-.3px}
.plant-gen{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:2px}
.plant-dates{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:1px}
.plant-actions{display:flex;gap:6px;align-items:flex-start}
.plant-stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.p-stat{background:var(--bg3);border-radius:9px;padding:8px 6px;text-align:center}
.p-stat-v{font-size:14px;font-weight:700}
.p-stat-l{font-family:'DM Mono',monospace;font-size:8px;color:var(--muted);margin-top:2px;letter-spacing:.5px}
.plant-note{font-size:12px;color:var(--muted);margin-top:8px;font-style:italic;line-height:1.4}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 155px)}
.chat-messages{flex:1;overflow-y:auto;padding:4px 0;display:flex;flex-direction:column;gap:10px}
.chat-messages::-webkit-scrollbar{width:0}
.msg{max-width:80%;display:flex;flex-direction:column;gap:3px}
.msg.mine{align-self:flex-end;align-items:flex-end}
.msg.theirs{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.45;word-break:break-word;position:relative}
.msg.mine .msg-bubble{background:linear-gradient(135deg,rgba(61,255,122,.18),rgba(61,255,122,.08));border:1px solid rgba(61,255,122,.22);border-bottom-right-radius:4px}
.msg.theirs .msg-bubble{background:var(--bg3);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg-meta{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);padding:0 4px}
.msg-sender-live{color:var(--green)}
.msg-sender-lil{color:var(--purple)}
.chat-bar{display:flex;gap:9px;align-items:flex-end;padding-top:10px;border-top:1px solid var(--border);margin-top:8px}
.chat-bar textarea{flex:1;max-height:90px;padding:10px 13px;font-size:14px}
.chat-empty{text-align:center;padding:30px;color:var(--muted);font-size:14px}

/* ‚îÄ‚îÄ CHECKLIST ‚îÄ‚îÄ */
.check-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg3);border-radius:11px;margin-bottom:8px;border:1px solid transparent;transition:all .2s}
.check-item.done-item{opacity:.45}
.check-item.done-item .ci-label{text-decoration:line-through}
.ci-box{width:20px;height:20px;border-radius:6px;border:1.5px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;background:transparent}
.ci-box.checked{background:var(--green);border-color:var(--green)}
.ci-label{flex:1;font-size:14px}
.ci-cost{font-family:'DM Mono',monospace;font-size:11px;color:var(--amber);flex-shrink:0}

/* ‚îÄ‚îÄ BAR CHART ‚îÄ‚îÄ */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:110px;padding:4px 0}
.bc-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.bc-bar{width:100%;border-radius:6px 6px 0 0;min-height:4px;background:linear-gradient(180deg,var(--green),rgba(61,255,122,.25));transition:height .6s ease}
.bc-val{font-family:'DM Mono',monospace;font-size:8px;color:var(--muted)}
.bc-name{font-family:'DM Mono',monospace;font-size:7px;color:var(--muted);text-align:center;max-width:38px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ‚îÄ‚îÄ STAT BARS ‚îÄ‚îÄ */
.stat-bar{margin-bottom:11px}
.sb-head{display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px}
.sb-track{background:var(--bg3);border-radius:4px;height:5px;overflow:hidden}
.sb-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),rgba(61,255,122,.35));transition:width .8s ease}

/* ‚îÄ‚îÄ ENV LOG ‚îÄ‚îÄ */
.env-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border-radius:10px;margin-bottom:7px}
.env-date{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);flex-shrink:0;width:52px}
.env-val{font-family:'DM Mono',monospace;font-size:12px;font-weight:700}
.env-note{font-size:12px;color:var(--muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ‚îÄ‚îÄ CAL ‚îÄ‚îÄ */
.cal-item{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:11px;margin-bottom:7px;border:1px solid;cursor:pointer;transition:all .2s}
.cal-date{font-family:'DM Mono',monospace;font-size:9px;flex-shrink:0;width:46px;text-align:center}
.cal-label{flex:1;font-size:13px;font-weight:600}
.cal-type{font-family:'DM Mono',monospace;font-size:9px;flex-shrink:0}

/* ‚îÄ‚îÄ CHIP FILTER ‚îÄ‚îÄ */
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.chip{padding:5px 13px;border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all .2s;letter-spacing:.5px}
.chip.on{border-color:var(--green);color:var(--green);background:var(--green-dim)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:22px 22px 0 0;padding:22px 20px 36px;width:100%;max-width:430px;max-height:92vh;overflow-y:auto;animation:slideUp .28s cubic-bezier(.16,1,.3,1)}
.modal::-webkit-scrollbar{width:0}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:19px;font-weight:800}
.modal-drag{width:38px;height:4px;background:var(--border2);border-radius:4px;margin:0 auto 18px}

/* ‚îÄ‚îÄ DONUT ‚îÄ‚îÄ */
.donut-wrap{display:flex;align-items:center;gap:18px}
.donut-legend{display:flex;flex-direction:column;gap:9px}
.leg-item{display:flex;align-items:center;gap:8px;font-size:12px}
.leg-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}

/* ‚îÄ‚îÄ SPLIT EDIT ‚îÄ‚îÄ */
.split-edit{background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid var(--border)}

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.div{height:1px;background:var(--border);margin:14px 0}

/* ‚îÄ‚îÄ CHAT HEADER ‚îÄ‚îÄ */
.chat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.online-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);display:inline-block;margin-right:5px}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
.content::-webkit-scrollbar,.modal::-webkit-scrollbar{width:0}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty{text-align:center;padding:44px 20px;color:var(--muted)}
.empty-icon{font-size:44px;margin-bottom:12px;display:block;filter:grayscale(.4)}
.empty-text{font-size:14px;line-height:1.5}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--card);border:1px solid var(--green);color:var(--green);font-family:'DM Mono',monospace;font-size:12px;padding:10px 20px;border-radius:30px;z-index:1000;transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 0 20px rgba(61,255,122,.2);white-space:nowrap}
#toast.show{transform:translateX(-50%) translateY(0)}

/* ‚îÄ‚îÄ FIREBASE STATUS ‚îÄ‚îÄ */
.fb-status{display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);padding:6px 12px;background:var(--bg3);border-radius:20px;border:1px solid var(--border)}
.fb-dot{width:6px;height:6px;border-radius:50%;background:var(--muted)}
.fb-dot.live{background:var(--green);box-shadow:0 0 6px var(--green)}

/* ‚îÄ‚îÄ SPLIT INPUT ‚îÄ‚îÄ */
.range-wrap{display:flex;gap:10px;align-items:center}
input[type=range]{padding:0;height:6px;-webkit-appearance:none;background:var(--border);border-radius:3px;border:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--green);border-radius:50%;cursor:pointer;box-shadow:0 0 10px var(--green-glow)}
.range-pct{font-family:'DM Mono',monospace;font-size:13px;color:var(--green);min-width:40px;text-align:right}

/* ‚îÄ‚îÄ PHOTO GRID ‚îÄ‚îÄ */
.photo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px}
.photo-thumb{aspect-ratio:1;border-radius:8px;background:var(--bg3);border:1px solid var(--border);overflow:hidden;position:relative;cursor:pointer}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-add{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:24px}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast"></div>

<!-- LOADING -->
<div id="loading">
  <div class="load-logo">üåø</div>
  <div style="font-size:26px;font-weight:800;letter-spacing:-1px">GrowManager</div>
  <div class="load-text">Connessione Firebase...</div>
</div>

<!-- LOGIN -->
<div id="login-screen" style="display:none">
  <div class="login-logo">
    <span>üåø</span>
    <h1>GrowManager</h1>
    <p>Sistema di Gestione</p>
  </div>
  <div class="login-cards">
    <div class="login-card live" onclick="selectUser('LIVE')">
      üå± LIVE
    </div>
    <div class="login-card lil" onclick="selectUser('LIL')">
      üíú LIL
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="main-app" style="display:none">

  <!-- CONTENT -->
  <div class="content" id="content">

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px">
        <div>
          <div class="page-eyebrow">GrowManager</div>
          <div class="page-title" id="home-greeting">Ciao üåø</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="fb-status" id="fb-status"><div class="fb-dot" id="fb-dot"></div><span id="fb-label">sync</span></div>
          <button class="btn btn-ghost btn-sm" onclick="logout()">esci</button>
        </div>
      </div>

      <!-- Last message preview -->
      <div class="card" id="last-msg-card" style="cursor:pointer;margin-bottom:12px;display:none" onclick="switchTab('chat')">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="section-label" style="margin:0">Ultimo Messaggio</div>
          <span class="badge badge-g" id="new-msg-badge" style="display:none">NUOVO</span>
        </div>
        <div id="last-msg-preview" style="font-size:13px;color:var(--muted)"></div>
      </div>

      <!-- Tiles -->
      <div class="tiles" id="home-tiles">
        <div class="tile"><div class="tile-val g" id="t-active">0</div><div class="tile-label">Piante Attive</div></div>
        <div class="tile"><div class="tile-val a" id="t-yield">0g</div><div class="tile-label">Resa Totale</div></div>
        <div class="tile"><div class="tile-val g" id="t-sales">‚Ç¨0</div><div class="tile-label">Vendite</div></div>
        <div class="tile"><div class="tile-val r" id="t-exp">-‚Ç¨0</div><div class="tile-label">Spese</div></div>
      </div>

      <!-- Profit Split -->
      <div class="card card-green" id="profit-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="section-label" style="margin:0">Divisione Utili Netti</div>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="toggleSplitEdit()" style="width:32px;height:32px">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
        </div>
        <div class="split-edit" id="split-edit-wrap" style="display:none">
          <label style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);display:block;margin-bottom:8px">% LIVE</label>
          <div class="range-wrap">
            <input type="range" min="0" max="100" value="60" id="split-range" oninput="onSplitChange(this.value)" style="flex:1">
            <span class="range-pct" id="split-range-label">60%</span>
          </div>
        </div>
        <div class="split-grid">
          <div class="split-side live">
            <div class="split-name">LIVE</div>
            <div class="split-amount live" id="s-live">‚Ç¨0</div>
            <div class="split-pct" id="sp-live">60%</div>
          </div>
          <div class="split-side lil">
            <div class="split-name">LIL</div>
            <div class="split-amount lil" id="s-lil">‚Ç¨0</div>
            <div class="split-pct" id="sp-lil">40%</div>
          </div>
        </div>
        <div class="split-footer">Utile netto: <span id="net-total">‚Ç¨0</span></div>
      </div>

      <!-- Upcoming event -->
      <div class="card" id="next-event-card" style="display:none;margin-bottom:12px">
        <div class="section-label">Prossimo Evento</div>
        <div style="display:flex;gap:12px;align-items:center">
          <span style="font-size:28px">üìÖ</span>
          <div>
            <div style="font-weight:700" id="next-event-title"></div>
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)" id="next-event-meta"></div>
          </div>
        </div>
      </div>

      <!-- Donut -->
      <div class="card" id="donut-card" style="display:none">
        <div class="section-label">Ripartizione Visiva</div>
        <div class="donut-wrap">
          <svg width="96" height="96" viewBox="0 0 100 100" id="donut-svg">
            <circle cx="50" cy="50" r="38" fill="none" stroke="#1c2830" stroke-width="14"/>
            <circle cx="50" cy="50" r="38" fill="none" stroke="#b060ff" stroke-width="14"
              stroke-dasharray="238.76 238.76" stroke-linecap="round" transform="rotate(-90 50 50)" id="donut-lil"/>
            <circle cx="50" cy="50" r="38" fill="none" stroke="#3dff7a" stroke-width="14"
              stroke-dasharray="143.25 238.76" stroke-linecap="round" transform="rotate(-90 50 50)" id="donut-live"/>
          </svg>
          <div class="donut-legend">
            <div class="leg-item"><div class="leg-dot" style="background:var(--green)"></div><span>LIVE <b id="donut-live-val">‚Ç¨0</b></span></div>
            <div class="leg-item"><div class="leg-dot" style="background:var(--purple)"></div><span>LIL <b id="donut-lil-val">‚Ç¨0</b></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PLANTS -->
    <div class="page" id="page-plants">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
        <div>
          <div class="page-eyebrow">Cicli & Piante</div>
          <div class="page-title" style="margin-bottom:0">Tracking Log</div>
        </div>
        <button class="btn btn-primary" onclick="openPlantModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><path d="M12 5v14M5 12h14"/></svg>
          Nuova
        </button>
      </div>
      <div class="chips" id="phase-chips">
        <button class="chip on" onclick="filterPlants('tutte',this)">tutte</button>
        <button class="chip" onclick="filterPlants('growing',this)">in crescita</button>
        <button class="chip" onclick="filterPlants('drying',this)">essiccazione</button>
        <button class="chip" onclick="filterPlants('done',this)">completate</button>
      </div>
      <div id="plants-list"></div>
    </div>

    <!-- ANALYTICS -->
    <div class="page" id="page-analytics">
      <div class="page-eyebrow">Analisi</div>
      <div class="page-title">Statistiche</div>
      <div class="tiles" id="analytics-tiles">
        <div class="tile"><div class="tile-val p" id="at-cycles">0</div><div class="tile-label">Cicli Completati</div></div>
        <div class="tile"><div class="tile-val a" id="at-avg-yield">0g</div><div class="tile-label">Resa Media</div></div>
        <div class="tile"><div class="tile-val g" id="at-avg-sale">‚Ç¨0</div><div class="tile-label">Ricavo Medio</div></div>
        <div class="tile"><div class="tile-val r" id="at-expenses">‚Ç¨0</div><div class="tile-label">Spese Totali</div></div>
      </div>
      <div class="card card-green" id="best-plant-card" style="display:none;margin-bottom:12px">
        <div class="section-label">Miglior Ciclo üèÜ</div>
        <div style="font-weight:700;font-size:18px" id="bp-name"></div>
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)" id="bp-meta"></div>
      </div>
      <div class="card">
        <div class="section-label">Profitti per Ciclo (‚Ç¨)</div>
        <div class="bar-chart" id="profit-bars"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="section-label">Rese per Pianta (g)</div>
        <div id="yield-bars"></div>
      </div>
      <!-- ENV LOG -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="section-label" style="margin:0">Parametri Ambientali</div>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="openEnvModal()" style="width:30px;height:30px;font-size:18px">+</button>
        </div>
        <div id="env-list"></div>
      </div>
      <!-- CALENDAR -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="section-label" style="margin:0">Calendario / Promemoria</div>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="openCalModal()" style="width:30px;height:30px;font-size:18px">+</button>
        </div>
        <div id="cal-list"></div>
      </div>
    </div>

    <!-- CHAT -->
    <div class="page" id="page-chat">
      <div class="chat-header">
        <div>
          <div class="page-eyebrow">Comunicazione</div>
          <div class="page-title" style="margin-bottom:0">Chat Live</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)">
          <div class="online-dot"></div>LIVE ¬∑ LIL
        </div>
      </div>
      <div class="chat-wrap">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-empty">Inizia la conversazione! üí¨</div>
        </div>
        <div class="chat-bar">
          <textarea id="chat-input" placeholder="Scrivi un messaggio..." rows="1" onkeydown="chatKeyDown(event)"></textarea>
          <button class="btn btn-primary btn-icon" onclick="sendMsg()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="17" height="17"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- SHOPPING -->
    <div class="page" id="page-shopping">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
        <div>
          <div class="page-eyebrow">Magazzino</div>
          <div class="page-title" style="margin-bottom:0">Lista & Inventario</div>
        </div>
        <button class="btn btn-primary" onclick="openShopModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><path d="M12 5v14M5 12h14"/></svg>
          Aggiungi
        </button>
      </div>
      <div class="card card-amber" id="expenses-card" style="display:none;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between">
          <span style="color:var(--muted);font-size:13px">Spese registrate</span>
          <span style="color:var(--red);font-family:'DM Mono',monospace;font-weight:700" id="total-expenses-label"></span>
        </div>
      </div>
      <div id="shop-todo-label" class="section-label" style="display:none"></div>
      <div id="shop-todo"></div>
      <div id="shop-done-sep" class="div" style="display:none"></div>
      <div id="shop-done-label" class="section-label" style="display:none"></div>
      <div id="shop-done"></div>
      <div id="shop-empty" class="empty" style="display:none">
        <span class="empty-icon">üõí</span>
        <div class="empty-text">La lista √® vuota.<br>Aggiungi materiali da acquistare.</div>
      </div>
    </div>

  </div><!-- /content -->

  <!-- NAV -->
  <nav class="nav">
    <button class="nav-btn active" onclick="switchTab('home')" id="nav-home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/></svg>
      Home
    </button>
    <button class="nav-btn" onclick="switchTab('plants')" id="nav-plants">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22V12M12 12C12 7 7 4 3 6M12 12C12 7 17 4 21 6M12 12C10 9 6 9 4 12M12 12C14 9 18 9 20 12"/></svg>
      Piante
    </button>
    <button class="nav-btn" onclick="switchTab('analytics')" id="nav-analytics">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 16l4-4 4 4 4-8"/></svg>
      Analisi
    </button>
    <button class="nav-btn" onclick="switchTab('chat')" id="nav-chat" style="position:relative">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      <div class="notif-dot" id="chat-notif" style="display:none"></div>
      Chat
    </button>
    <button class="nav-btn" onclick="switchTab('shopping')" id="nav-shopping">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4zM3 6h18M16 10a4 4 0 01-8 0"/></svg>
      Lista
    </button>
  </nav>

</div><!-- /app -->

<!-- PLANT MODAL -->
<div class="overlay" id="plant-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-top">
      <div class="modal-title" id="plant-modal-title">Nuova Pianta üå±</div>
      <button class="btn btn-ghost btn-icon" onclick="closePlantModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="17" height="17"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="field"><label>Nome Pianta *</label><input id="p-name" placeholder="es. Northern Lights #3"/></div>
    <div class="field"><label>Genetica</label><input id="p-gen" placeholder="es. Indica 70% / Sativa 30%"/></div>
    <div class="field-row">
      <div class="field"><label>Data Inizio</label><input type="date" id="p-start"/></div>
      <div class="field"><label>Data Fine</label><input type="date" id="p-end"/></div>
    </div>
    <div class="field-row">
      <div class="field"><label>Resa (g)</label><input type="number" id="p-yield" placeholder="0" oninput="updatePlantCalc()"/></div>
      <div class="field"><label>Vendita (‚Ç¨)</label><input type="number" id="p-sale" placeholder="0" oninput="updatePlantCalc()"/></div>
    </div>
    <div class="card" id="plant-calc-preview" style="display:none;background:var(--bg3);margin-bottom:14px">
      <div style="display:flex;justify-content:space-around;text-align:center">
        <div><div style="font-weight:700;color:var(--green)" id="pc-live">‚Ç¨0</div><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)">LIVE</div></div>
        <div><div style="font-weight:700;color:var(--purple)" id="pc-lil">‚Ç¨0</div><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)">LIL</div></div>
      </div>
    </div>
    <div class="field"><label>Stato</label>
      <select id="p-status">
        <option value="growing">üå± In crescita</option>
        <option value="drying">üåæ Essiccazione</option>
        <option value="done">‚úÖ Completata</option>
      </select>
    </div>
    <div class="field"><label>Note</label><textarea id="p-notes" rows="3" placeholder="Osservazioni, problemi..."></textarea></div>
    <input type="hidden" id="p-editing-id"/>
    <div style="display:flex;gap:10px">
      <button class="btn btn-danger" id="plant-del-btn" style="display:none" onclick="deletePlant()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="15" height="15"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>Elimina
      </button>
      <button class="btn btn-primary btn-full" onclick="savePlant()">Salva Pianta</button>
    </div>
  </div>
</div>

<!-- SHOP MODAL -->
<div class="overlay" id="shop-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-top">
      <div class="modal-title">Aggiungi Articolo üõí</div>
      <button class="btn btn-ghost btn-icon" onclick="closeShopModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="17" height="17"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="field"><label>Articolo *</label><input id="sh-name" placeholder="es. Terra, Fertilizzante B52..."/></div>
    <div class="field"><label>Costo (‚Ç¨)</label><input type="number" id="sh-cost" placeholder="0.00"/></div>
    <div class="field"><label>Note</label><input id="sh-note" placeholder="opzionale"/></div>
    <button class="btn btn-primary btn-full" onclick="saveShopItem()">Aggiungi alla lista</button>
  </div>
</div>

<!-- ENV MODAL -->
<div class="overlay" id="env-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-top">
      <div class="modal-title">Parametri Ambientali üå°</div>
      <button class="btn btn-ghost btn-icon" onclick="closeEnvModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="17" height="17"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="field-row">
      <div class="field"><label>Temperatura ¬∞C</label><input type="number" id="env-temp" placeholder="24"/></div>
      <div class="field"><label>Umidit√† %</label><input type="number" id="env-hum" placeholder="55"/></div>
    </div>
    <div class="field"><label>Data</label><input type="date" id="env-date"/></div>
    <div class="field"><label>Nota</label><input id="env-note" placeholder="Tutto ok, piccola deriva..."/></div>
    <button class="btn btn-primary btn-full" onclick="saveEnv()">Salva Parametri</button>
  </div>
</div>

<!-- CAL MODAL -->
<div class="overlay" id="cal-modal">
  <div class="modal">
    <div class="modal-drag"></div>
    <div class="modal-top">
      <div class="modal-title">Nuovo Promemoria üìÖ</div>
      <button class="btn btn-ghost btn-icon" onclick="closeCalModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="17" height="17"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="field"><label>Data</label><input type="date" id="cal-date"/></div>
    <div class="field"><label>Tipo</label>
      <select id="cal-type">
        <option value="annaffiatura">üíß Annaffiatura</option>
        <option value="nutrienti">üß™ Nutrienti</option>
        <option value="luci">üí° Luci</option>
        <option value="altro">üìå Altro</option>
      </select>
    </div>
    <div class="field"><label>Descrizione *</label><input id="cal-title" placeholder="es. Dosi 2ml/L Grow A+B"/></div>
    <button class="btn btn-primary btn-full" onclick="saveCal()">Aggiungi</button>
  </div>
</div>

<!-- FIREBASE SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, onSnapshot,
  addDoc, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAq4qISQeQCeqUH2PbGdvTEuOvLhISMfyc",
  authDomain: "growing-52acb.firebaseapp.com",
  projectId: "growing-52acb",
  storageBucket: "growing-52acb.firebasestorage.app",
  messagingSenderId: "660613829997",
  appId: "1:660613829997:web:29e2a21ab4e811b3e8b664"
};

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
window.db = db;
window.fsLib = { collection, doc, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, getDoc };

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
window.state = {
  user: null,
  plants: [],
  messages: [],
  shopping: [],
  envLogs: [],
  calEvents: [],
  splitLive: 60,
  activeTab: 'home',
  filterPhase: 'tutte',
  editingPlantId: null,
  lastMsgTs: null,
  unsubscribers: []
};

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
window.today = () => new Date().toISOString().slice(0,10);
window.fmtDate = (d) => {
  if (!d) return '‚Äî';
  const dt = (d?.toDate ? d.toDate() : new Date(d));
  return dt.toLocaleDateString('it-IT',{day:'2-digit',month:'short'});
};
window.nowTs = () => new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});

window.showToast = (msg) => {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
};

// ‚îÄ‚îÄ FB STATUS ‚îÄ‚îÄ
window.setFbStatus = (live) => {
  document.getElementById('fb-dot').className = live ? 'fb-dot live' : 'fb-dot';
  document.getElementById('fb-label').textContent = live ? 'sincronizzato' : 'connessione...';
};

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
window.selectUser = (user) => {
  window.state.user = user;
  localStorage.setItem('gm_user', user);
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'flex';
  document.getElementById('home-greeting').textContent = `Ciao, ${user} üåø`;
  startListeners();
  renderAll();
};

window.logout = () => {
  window.state.unsubscribers.forEach(u => u());
  window.state.unsubscribers = [];
  window.state.user = null;
  localStorage.removeItem('gm_user');
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
};

// ‚îÄ‚îÄ LISTENERS ‚îÄ‚îÄ
function startListeners() {
  const { collection, doc, onSnapshot, query, orderBy } = window.fsLib;
  const db = window.db;
  const u = window.state.unsubscribers;

  // Settings (split)
  u.push(onSnapshot(doc(db,'settings','main'), snap => {
    if (snap.exists()) {
      const d = snap.data();
      window.state.splitLive = d.splitLive ?? 60;
      document.getElementById('split-range').value = window.state.splitLive;
      document.getElementById('split-range-label').textContent = window.state.splitLive + '%';
    }
    setFbStatus(true);
    renderHome();
  }, () => setFbStatus(false)));

  // Plants
  u.push(onSnapshot(collection(db,'plants'), snap => {
    window.state.plants = snap.docs.map(d => ({id:d.id,...d.data()}));
    renderAll();
  }));

  // Messages
  u.push(onSnapshot(query(collection(db,'messages'), orderBy('ts','asc')), snap => {
    const prev = window.state.messages.length;
    window.state.messages = snap.docs.map(d => ({id:d.id,...d.data()}));
    if (window.state.messages.length > prev && prev > 0) {
      const last = window.state.messages[window.state.messages.length-1];
      if (last.sender !== window.state.user && window.state.activeTab !== 'chat') {
        document.getElementById('chat-notif').style.display = 'block';
        try { new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAA...").play(); } catch(e){}
      }
    }
    renderChat();
    renderHome();
  }));

  // Shopping
  u.push(onSnapshot(collection(db,'shopping'), snap => {
    window.state.shopping = snap.docs.map(d => ({id:d.id,...d.data()}));
    renderShopping();
    renderHome();
  }));

  // Env
  u.push(onSnapshot(query(collection(db,'env'), orderBy('date','asc')), snap => {
    window.state.envLogs = snap.docs.map(d => ({id:d.id,...d.data()}));
    renderEnv();
  }));

  // Calendar
  u.push(onSnapshot(collection(db,'calendar'), snap => {
    window.state.calEvents = snap.docs.map(d => ({id:d.id,...d.data()}));
    renderCal();
    renderHome();
  }));
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
window.switchTab = (tab) => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('nav-'+tab).classList.add('active');
  window.state.activeTab = tab;
  if (tab === 'chat') {
    document.getElementById('chat-notif').style.display = 'none';
    setTimeout(() => {
      const m = document.getElementById('chat-messages');
      m.scrollTop = m.scrollHeight;
    }, 100);
  }
  if (tab === 'analytics') { renderAnalytics(); }
};

// ‚îÄ‚îÄ CALCS ‚îÄ‚îÄ
window.getCalcs = () => {
  const { plants, shopping, splitLive } = window.state;
  const completed = plants.filter(p => parseFloat(p.sale) > 0);
  const totalSale = completed.reduce((s,p) => s+(parseFloat(p.sale)||0),0);
  const expenses = shopping.filter(s => s.checked && s.cost).reduce((s,i) => s+(parseFloat(i.cost)||0),0);
  const net = totalSale - expenses;
  const liveAmt = net * (splitLive/100);
  const lilAmt = net * ((100-splitLive)/100);
  const active = plants.filter(p => p.status === 'growing' || p.status === 'drying').length;
  const totalYield = plants.reduce((s,p) => s+(parseFloat(p.yield)||0),0);
  return { totalSale, expenses, net, liveAmt, lilAmt, active, totalYield, completed };
};

// ‚îÄ‚îÄ RENDER HOME ‚îÄ‚îÄ
window.renderHome = () => {
  const c = getCalcs();
  document.getElementById('t-active').textContent = c.active;
  document.getElementById('t-yield').textContent = c.totalYield.toFixed(0)+'g';
  document.getElementById('t-sales').textContent = '‚Ç¨'+c.totalSale.toFixed(0);
  document.getElementById('t-exp').textContent = '-‚Ç¨'+c.expenses.toFixed(0);
  document.getElementById('s-live').textContent = '‚Ç¨'+c.liveAmt.toFixed(0);
  document.getElementById('s-lil').textContent = '‚Ç¨'+c.lilAmt.toFixed(0);
  document.getElementById('sp-live').textContent = window.state.splitLive+'%';
  document.getElementById('sp-lil').textContent = (100-window.state.splitLive)+'%';
  document.getElementById('net-total').textContent = '‚Ç¨'+c.net.toFixed(2);

  // Donut
  if (c.net > 0) {
    document.getElementById('donut-card').style.display = '';
    const circ = 238.76;
    const liveDash = (c.liveAmt / c.net) * circ;
    document.getElementById('donut-live').setAttribute('stroke-dasharray', `${liveDash} ${circ}`);
    document.getElementById('donut-lil').setAttribute('stroke-dasharray', `${circ} ${circ}`);
    document.getElementById('donut-live-val').textContent = '‚Ç¨'+c.liveAmt.toFixed(0);
    document.getElementById('donut-lil-val').textContent = '‚Ç¨'+c.lilAmt.toFixed(0);
  } else {
    document.getElementById('donut-card').style.display = 'none';
  }

  // Last message
  const msgs = window.state.messages;
  if (msgs.length > 0) {
    const last = msgs[msgs.length-1];
    document.getElementById('last-msg-card').style.display = '';
    const sColor = last.sender === 'LIVE' ? 'var(--green)' : 'var(--purple)';
    document.getElementById('last-msg-preview').innerHTML = `<span style="color:${sColor};font-weight:700">${last.sender}: </span>${last.text}`;
    const isUnread = last.sender !== window.state.user && window.state.activeTab !== 'chat';
    document.getElementById('new-msg-badge').style.display = isUnread ? '' : 'none';
  }

  // Next event
  const upcoming = window.state.calEvents
    .filter(e => !e.done)
    .sort((a,b) => {
      const da = a.date?.toDate ? a.date.toDate() : new Date(a.date);
      const db2 = b.date?.toDate ? b.date.toDate() : new Date(b.date);
      return da - db2;
    })[0];
  if (upcoming) {
    document.getElementById('next-event-card').style.display = '';
    document.getElementById('next-event-title').textContent = upcoming.title;
    const evDate = upcoming.date?.toDate ? upcoming.date.toDate() : new Date(upcoming.date);
    document.getElementById('next-event-meta').textContent = evDate.toLocaleDateString('it-IT',{day:'2-digit',month:'long'}) + ' ¬∑ ' + upcoming.type;
  } else {
    document.getElementById('next-event-card').style.display = 'none';
  }
};

// ‚îÄ‚îÄ RENDER PLANTS ‚îÄ‚îÄ
window.renderPlants = () => {
  const { plants, filterPhase } = window.state;
  const filtered = filterPhase === 'tutte' ? plants : plants.filter(p => p.status === filterPhase);
  const el = document.getElementById('plants-list');
  if (filtered.length === 0) {
    el.innerHTML = `<div class="empty"><span class="empty-icon">üå±</span><div class="empty-text">Nessuna pianta trovata.</div></div>`;
    return;
  }
  const phaseBadge = {growing:'badge-g',drying:'badge-a',done:'badge-p'};
  const phaseLabel = {growing:'In crescita',drying:'Essiccazione',done:'Completata'};
  el.innerHTML = filtered.map(p => {
    const split = window.state.splitLive;
    const sale = parseFloat(p.sale)||0;
    const liveAmt = (sale * split/100).toFixed(0);
    const lilAmt = (sale * (100-split)/100).toFixed(0);
    const start = p.dateStart?.toDate ? p.dateStart.toDate() : (p.dateStart ? new Date(p.dateStart) : null);
    const end = p.dateEnd?.toDate ? p.dateEnd.toDate() : (p.dateEnd ? new Date(p.dateEnd) : null);
    const days = start ? Math.round(((end||new Date()) - start)/86400000) : 0;
    const badge = phaseBadge[p.status||'growing'] || 'badge-m';
    const label = phaseLabel[p.status||'growing'] || p.status;
    const cls = p.status||'growing';
    return `<div class="plant-card ${cls}" onclick="openPlantModal('${p.id}')">
      <div class="plant-top">
        <div>
          <div class="plant-name">${p.name||'Pianta'}</div>
          ${p.genetics ? `<div class="plant-gen">gen: ${p.genetics}</div>` : ''}
          <div class="plant-dates">${fmtDate(p.dateStart)} ‚Üí ${end ? fmtDate(p.dateEnd) : 'oggi'}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end">
          <span class="badge ${badge}">${label}</span>
          ${days > 0 ? `<span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)">${days}gg</span>` : ''}
        </div>
      </div>
      ${(p.yield || p.sale) ? `<div class="plant-stats-row">
        <div class="p-stat"><div class="p-stat-v" style="color:var(--amber)">${p.yield||'‚Äî'}g</div><div class="p-stat-l">RESA</div></div>
        <div class="p-stat"><div class="p-stat-v" style="color:var(--green)">‚Ç¨${liveAmt}</div><div class="p-stat-l">LIVE</div></div>
        <div class="p-stat"><div class="p-stat-v" style="color:var(--purple)">‚Ç¨${lilAmt}</div><div class="p-stat-l">LIL</div></div>
      </div>` : ''}
      ${p.notes ? `<div class="plant-note">${p.notes}</div>` : ''}
    </div>`;
  }).join('');
};

window.filterPlants = (phase, btn) => {
  window.state.filterPhase = phase;
  document.querySelectorAll('#phase-chips .chip').forEach(c => c.classList.remove('on'));
  btn.classList.add('on');
  renderPlants();
};

// ‚îÄ‚îÄ PLANT MODAL ‚îÄ‚îÄ
window.openPlantModal = async (id) => {
  document.getElementById('plant-modal').classList.add('open');
  document.getElementById('p-start').value = today();
  if (id) {
    window.state.editingPlantId = id;
    document.getElementById('plant-modal-title').textContent = 'Modifica Pianta ‚úèÔ∏è';
    document.getElementById('plant-del-btn').style.display = '';
    const plant = window.state.plants.find(p => p.id === id);
    if (plant) {
      document.getElementById('p-name').value = plant.name||'';
      document.getElementById('p-gen').value = plant.genetics||'';
      const ps = plant.dateStart?.toDate ? plant.dateStart.toDate() : (plant.dateStart ? new Date(plant.dateStart) : null);
      const pe = plant.dateEnd?.toDate ? plant.dateEnd.toDate() : (plant.dateEnd ? new Date(plant.dateEnd) : null);
      if (ps) document.getElementById('p-start').value = ps.toISOString().slice(0,10);
      if (pe) document.getElementById('p-end').value = pe.toISOString().slice(0,10);
      document.getElementById('p-yield').value = plant.yield||'';
      document.getElementById('p-sale').value = plant.sale||'';
      document.getElementById('p-status').value = plant.status||'growing';
      document.getElementById('p-notes').value = plant.notes||'';
      document.getElementById('p-editing-id').value = id;
      updatePlantCalc();
    }
  } else {
    window.state.editingPlantId = null;
    document.getElementById('plant-modal-title').textContent = 'Nuova Pianta üå±';
    document.getElementById('plant-del-btn').style.display = 'none';
    ['p-name','p-gen','p-end','p-yield','p-sale','p-notes'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('p-status').value = 'growing';
    document.getElementById('p-editing-id').value = '';
    document.getElementById('plant-calc-preview').style.display = 'none';
  }
};

window.closePlantModal = () => {
  document.getElementById('plant-modal').classList.remove('open');
};

window.updatePlantCalc = () => {
  const sale = parseFloat(document.getElementById('p-sale').value)||0;
  if (sale > 0) {
    const sl = window.state.splitLive;
    document.getElementById('pc-live').textContent = '‚Ç¨'+(sale*sl/100).toFixed(2);
    document.getElementById('pc-lil').textContent = '‚Ç¨'+(sale*(100-sl)/100).toFixed(2);
    document.getElementById('plant-calc-preview').style.display = '';
  } else {
    document.getElementById('plant-calc-preview').style.display = 'none';
  }
};

window.savePlant = async () => {
  const name = document.getElementById('p-name').value.trim();
  if (!name) { showToast('‚ö†Ô∏è Inserisci il nome'); return; }
  const { addDoc, setDoc, doc, collection } = window.fsLib;
  const db = window.db;
  const data = {
    name,
    genetics: document.getElementById('p-gen').value,
    dateStart: document.getElementById('p-start').value || null,
    dateEnd: document.getElementById('p-end').value || null,
    yield: document.getElementById('p-yield').value,
    sale: document.getElementById('p-sale').value,
    status: document.getElementById('p-status').value,
    notes: document.getElementById('p-notes').value,
    updatedAt: window.fsLib.serverTimestamp()
  };
  const editId = document.getElementById('p-editing-id').value;
  if (editId) {
    await setDoc(doc(db,'plants',editId), data, {merge:true});
    showToast('‚úÖ Pianta aggiornata');
  } else {
    data.createdAt = window.fsLib.serverTimestamp();
    await addDoc(collection(db,'plants'), data);
    showToast('üå± Pianta aggiunta');
  }
  closePlantModal();
};

window.deletePlant = async () => {
  if (!confirm('Eliminare questa pianta?')) return;
  const { deleteDoc, doc } = window.fsLib;
  const id = document.getElementById('p-editing-id').value;
  await deleteDoc(doc(window.db,'plants',id));
  showToast('üóëÔ∏è Eliminata');
  closePlantModal();
};

// ‚îÄ‚îÄ SPLIT ‚îÄ‚îÄ
window.toggleSplitEdit = () => {
  const w = document.getElementById('split-edit-wrap');
  w.style.display = w.style.display === 'none' ? '' : 'none';
};
window.onSplitChange = async (val) => {
  window.state.splitLive = parseInt(val);
  document.getElementById('split-range-label').textContent = val+'%';
  renderHome();
  const { setDoc, doc } = window.fsLib;
  await setDoc(doc(window.db,'settings','main'), {splitLive: parseInt(val)}, {merge:true});
};

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ
window.renderChat = () => {
  const msgs = window.state.messages;
  const el = document.getElementById('chat-messages');
  if (msgs.length === 0) {
    el.innerHTML = '<div class="chat-empty">Inizia la conversazione! üí¨</div>';
    return;
  }
  el.innerHTML = msgs.map(m => {
    const mine = m.sender === window.state.user;
    const sClass = m.sender === 'LIVE' ? 'msg-sender-live' : 'msg-sender-lil';
    return `<div class="msg ${mine ? 'mine' : 'theirs'}">
      <div class="msg-meta"><span class="${sClass}">${m.sender}</span> ¬∑ ${m.time||''}</div>
      <div class="msg-bubble">${m.text}</div>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
};

window.sendMsg = async () => {
  const inp = document.getElementById('chat-input');
  const text = inp.value.trim();
  if (!text || !window.state.user) return;
  const { addDoc, collection } = window.fsLib;
  await addDoc(collection(window.db,'messages'), {
    sender: window.state.user,
    text,
    time: nowTs(),
    ts: window.fsLib.serverTimestamp()
  });
  inp.value = '';
};

window.chatKeyDown = (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
};

// ‚îÄ‚îÄ SHOPPING ‚îÄ‚îÄ
window.renderShopping = () => {
  const { shopping } = window.state;
  const todo = shopping.filter(s => !s.checked);
  const done = shopping.filter(s => s.checked);
  const totalCost = done.reduce((s,i) => s+(parseFloat(i.cost)||0),0);

  if (totalCost > 0) {
    document.getElementById('expenses-card').style.display = '';
    document.getElementById('total-expenses-label').textContent = '-‚Ç¨'+totalCost.toFixed(2);
  } else document.getElementById('expenses-card').style.display = 'none';

  document.getElementById('shop-empty').style.display = shopping.length === 0 ? '' : 'none';

  const mkItem = (item) => `<div class="check-item ${item.checked ? 'done-item' : ''}" id="si-${item.id}">
    <div class="ci-box ${item.checked ? 'checked' : ''}" onclick="toggleShop('${item.id}')">
      ${item.checked ? `<svg viewBox="0 0 24 24" fill="none" stroke="#060c09" stroke-width="3" width="11" height="11"><path d="M20 6L9 17l-5-5"/></svg>` : ''}
    </div>
    <span class="ci-label">${item.name}${item.shopNote ? `<span style="font-size:11px;color:var(--muted)"> ¬∑ ${item.shopNote}</span>` : ''}</span>
    ${item.cost ? `<span class="ci-cost">‚Ç¨${item.cost}</span>` : ''}
    <button class="btn btn-ghost btn-icon" style="width:28px;height:28px" onclick="deleteShop('${item.id}')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="12" height="12"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
    </button>
  </div>`;

  document.getElementById('shop-todo-label').style.display = todo.length ? '' : 'none';
  document.getElementById('shop-todo-label').textContent = `Da comprare (${todo.length})`;
  document.getElementById('shop-todo').innerHTML = todo.map(mkItem).join('');

  document.getElementById('shop-done-sep').style.display = done.length ? '' : 'none';
  document.getElementById('shop-done-label').style.display = done.length ? '' : 'none';
  document.getElementById('shop-done-label').textContent = 'Acquistati ‚úì';
  document.getElementById('shop-done').innerHTML = done.map(mkItem).join('');
};

window.openShopModal = () => {
  document.getElementById('sh-name').value = '';
  document.getElementById('sh-cost').value = '';
  document.getElementById('sh-note').value = '';
  document.getElementById('shop-modal').classList.add('open');
};
window.closeShopModal = () => document.getElementById('shop-modal').classList.remove('open');
window.saveShopItem = async () => {
  const name = document.getElementById('sh-name').value.trim();
  if (!name) { showToast('‚ö†Ô∏è Inserisci un nome'); return; }
  const { addDoc, collection } = window.fsLib;
  await addDoc(collection(window.db,'shopping'), {
    name,
    cost: document.getElementById('sh-cost').value,
    shopNote: document.getElementById('sh-note').value,
    checked: false,
    createdAt: window.fsLib.serverTimestamp()
  });
  showToast('üõí Aggiunto');
  closeShopModal();
};
window.toggleShop = async (id) => {
  const { updateDoc, doc } = window.fsLib;
  const item = window.state.shopping.find(s => s.id === id);
  if (item) await updateDoc(doc(window.db,'shopping',id), {checked: !item.checked});
};
window.deleteShop = async (id) => {
  const { deleteDoc, doc } = window.fsLib;
  await deleteDoc(doc(window.db,'shopping',id));
};

// ‚îÄ‚îÄ ENV ‚îÄ‚îÄ
window.renderEnv = () => {
  const logs = [...window.state.envLogs].reverse().slice(0,6);
  const el = document.getElementById('env-list');
  if (logs.length === 0) { el.innerHTML = '<div style="color:var(--muted);font-size:13px">Nessun dato registrato.</div>'; return; }
  el.innerHTML = logs.map(l => {
    const d = l.date?.toDate ? l.date.toDate() : new Date(l.date);
    return `<div class="env-row">
      <span class="env-date">${d.toLocaleDateString('it-IT',{day:'2-digit',month:'short'})}</span>
      ${l.temp ? `<span class="env-val" style="color:var(--amber)">üå° ${l.temp}¬∞C</span>` : ''}
      ${l.hum ? `<span class="env-val" style="color:var(--blue)">üíß ${l.hum}%</span>` : ''}
      ${l.note ? `<span class="env-note">${l.note}</span>` : ''}
    </div>`;
  }).join('');
};
window.openEnvModal = () => {
  document.getElementById('env-date').value = today();
  document.getElementById('env-temp').value = '';
  document.getElementById('env-hum').value = '';
  document.getElementById('env-note').value = '';
  document.getElementById('env-modal').classList.add('open');
};
window.closeEnvModal = () => document.getElementById('env-modal').classList.remove('open');
window.saveEnv = async () => {
  const temp = document.getElementById('env-temp').value;
  const hum = document.getElementById('env-hum').value;
  if (!temp && !hum) { showToast('‚ö†Ô∏è Inserisci almeno un valore'); return; }
  const { addDoc, collection } = window.fsLib;
  await addDoc(collection(window.db,'env'), {
    temp, hum,
    date: document.getElementById('env-date').value,
    note: document.getElementById('env-note').value,
    ts: window.fsLib.serverTimestamp()
  });
  showToast('üå° Parametri salvati');
  closeEnvModal();
};

// ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ
window.renderCal = () => {
  const upcoming = window.state.calEvents
    .filter(e => !e.done)
    .sort((a,b) => {
      const da = a.date?.toDate ? a.date.toDate() : new Date(a.date);
      const db2 = b.date?.toDate ? b.date.toDate() : new Date(b.date);
      return da - db2;
    });
  const el = document.getElementById('cal-list');
  const typeColor = {annaffiatura:'var(--blue)',nutrienti:'var(--green)',luci:'var(--amber)',altro:'var(--muted)'};
  const typeEmoji = {annaffiatura:'üíß',nutrienti:'üß™',luci:'üí°',altro:'üìå'};
  if (upcoming.length === 0) { el.innerHTML = '<div style="color:var(--muted);font-size:13px">Nessun evento programmato.</div>'; return; }
  el.innerHTML = upcoming.map(ev => {
    const c = typeColor[ev.type]||'var(--muted)';
    const em = typeEmoji[ev.type]||'üìå';
    const d = ev.date?.toDate ? ev.date.toDate() : new Date(ev.date);
    return `<div class="cal-item" style="border-color:${c}33;background:${c}08" onclick="doneCalEvent('${ev.id}')">
      <div class="cal-date" style="color:${c}">${d.toLocaleDateString('it-IT',{day:'2-digit',month:'short'})}</div>
      <div class="cal-label">${ev.title}</div>
      <div class="cal-type" style="color:${c}">${em} ${ev.type}</div>
    </div>`;
  }).join('');
  renderHome();
};
window.openCalModal = () => {
  document.getElementById('cal-date').value = today();
  document.getElementById('cal-title').value = '';
  document.getElementById('cal-type').value = 'annaffiatura';
  document.getElementById('cal-modal').classList.add('open');
};
window.closeCalModal = () => document.getElementById('cal-modal').classList.remove('open');
window.saveCal = async () => {
  const title = document.getElementById('cal-title').value.trim();
  if (!title) { showToast('‚ö†Ô∏è Inserisci una descrizione'); return; }
  const { addDoc, collection } = window.fsLib;
  await addDoc(collection(window.db,'calendar'), {
    title,
    type: document.getElementById('cal-type').value,
    date: document.getElementById('cal-date').value,
    done: false,
    ts: window.fsLib.serverTimestamp()
  });
  showToast('üìÖ Promemoria aggiunto');
  closeCalModal();
};
window.doneCalEvent = async (id) => {
  const { updateDoc, doc } = window.fsLib;
  await updateDoc(doc(window.db,'calendar',id), {done:true});
  showToast('‚úÖ Evento completato');
};

// ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ
window.renderAnalytics = () => {
  const { plants } = window.state;
  const c = getCalcs();
  const completed = c.completed;
  document.getElementById('at-cycles').textContent = completed.length;
  const avgY = completed.length ? (completed.reduce((s,p) => s+(parseFloat(p.yield)||0),0)/completed.length).toFixed(1) : 0;
  const avgS = completed.length ? (completed.reduce((s,p) => s+(parseFloat(p.sale)||0),0)/completed.length).toFixed(0) : 0;
  document.getElementById('at-avg-yield').textContent = avgY+'g';
  document.getElementById('at-avg-sale').textContent = '‚Ç¨'+avgS;
  document.getElementById('at-expenses').textContent = '‚Ç¨'+c.expenses.toFixed(0);

  // Best plant
  const best = completed.reduce((b,p) => (!b||parseFloat(p.sale)>parseFloat(b.sale)) ? p : b, null);
  if (best) {
    document.getElementById('best-plant-card').style.display = '';
    document.getElementById('bp-name').textContent = best.name;
    document.getElementById('bp-meta').textContent = '‚Ç¨'+best.sale+' ¬∑ '+(best.yield||'‚Äî')+'g';
  } else document.getElementById('best-plant-card').style.display = 'none';

  // Bar chart
  const maxSale = completed.length ? Math.max(...completed.map(p => parseFloat(p.sale)||0)) : 0;
  const bars = document.getElementById('profit-bars');
  if (completed.length === 0) { bars.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:8px">Nessun ciclo completato.</div>'; }
  else {
    bars.innerHTML = completed.slice(-8).map(p => {
      const h = maxSale ? Math.max(4,(parseFloat(p.sale)||0)/maxSale*98) : 4;
      return `<div class="bc-col">
        <div class="bc-val">‚Ç¨${p.sale}</div>
        <div class="bc-bar" style="height:${h}px"></div>
        <div class="bc-name">${p.name}</div>
      </div>`;
    }).join('');
  }

  // Yield bars
  const withYield = plants.filter(p => p.yield);
  const maxY = withYield.length ? Math.max(...withYield.map(p => parseFloat(p.yield)||0)) : 0;
  const yb = document.getElementById('yield-bars');
  if (withYield.length === 0) { yb.innerHTML = '<div style="color:var(--muted);font-size:13px">Nessun dato.</div>'; }
  else {
    yb.innerHTML = withYield.map(p => {
      const pct = maxY ? (parseFloat(p.yield)||0)/maxY*100 : 0;
      return `<div class="stat-bar">
        <div class="sb-head"><span>${p.name}</span><span style="font-family:'DM Mono',monospace;font-size:11px">${p.yield}g</span></div>
        <div class="sb-track"><div class="sb-fill" style="width:${pct}%"></div></div>
      </div>`;
    }).join('');
  }
};

window.renderAll = () => {
  renderHome();
  renderPlants();
  renderAnalytics();
  renderShopping();
  renderEnv();
  renderCal();
};

// ‚îÄ‚îÄ OVERLAY CLOSE ON OUTSIDE TAP ‚îÄ‚îÄ
document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('load', () => {
  const savedUser = localStorage.getItem('gm_user');
  document.getElementById('loading').style.display = 'none';
  if (savedUser) {
    window.state.user = savedUser;
    document.getElementById('main-app').style.display = 'flex';
    document.getElementById('home-greeting').textContent = `Ciao, ${savedUser} üåø`;
    startListeners();
  } else {
    document.getElementById('login-screen').style.display = 'flex';
  }
});
</script>
</body>
</html>
